<!DOCTYPE html>
<html>
<head>
  <title>Hello DApp with MetaMask</title>
</head>
<body>
  <h1>HelloWorld DApp</h1>
  <p>Message: <span id="message">Loading...</span></p>
  <input type="text" id="newMessage" placeholder="New message" />
  <button id="setMessageButton">Set Message</button>
  <button id="refreshButton">Refresh Message</button>
  <button id="connectButton">Connect Wallet</button>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const contractAddress = "0xCE..."; // Replace with your deployed contract address
    const abi = [
      "function message() view returns (string)",
      "function setMessage(string _message)"
    ];

    let provider;
    let signer;
    let contract;

    async function connectWallet() {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          contract = new ethers.Contract(contractAddress, abi, signer);
          console.log("Wallet connected");
          getMessage();
        } catch (error) {
          console.error("User denied wallet connection", error);
        }
      } else {
        alert("Please install MetaMask!");
      }
    }

    async function getMessage() {
      if (!provider) {
        document.getElementById("message").textContent = "Wallet not connected";
        return;
      }
      try {
        const msg = await contract.message();
        document.getElementById("message").textContent = msg;
      } catch (error) {
        console.error("Error fetching message:", error);
        document.getElementById("message").textContent = "Error fetching message";
      }
    }

    async function setMessage() {
      if (!provider) {
        alert("Please connect your wallet first.");
        return;
      }
      const newMsg = document.getElementById("newMessage").value;
      try {
        const tx = await contract.setMessage(newMsg);
        await tx.wait();
        getMessage();
      } catch (error) {
        console.error("Error setting message:", error);
      }
    }

    document.getElementById("connectButton").addEventListener("click", connectWallet);
    document.getElementById("setMessageButton").addEventListener("click", setMessage);
    document.getElementById("refreshButton").addEventListener("click", getMessage);

    // Automatically try to connect wallet if already authorized
    window.addEventListener('load', async () => {
      if (window.ethereum && window.ethereum.selectedAddress) {
        connectWallet();
      }
    });
  </script>
</body>
</html>
